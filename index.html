<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Our Diary</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Noto+Serif+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink: #1A1D24;
      --deep: #2A3441;
      --navy: #3D4A5C;
      --steel: #5A6978;
      --slate: #7A8694;
      --muted: #9BA4B0;
      --silver: #C4CAD4;
      --frost: #E4E8ED;
      --cloud: #F2F4F7;
      --snow: #FAFBFC;
      
      --accent: #4A7C9B;
      --accent-light: #6B9DBB;
      --accent-soft: rgba(74,124,155,0.1);
      
      --shadow-sm: 0 1px 3px rgba(26,29,36,0.05);
      --shadow-md: 0 4px 12px rgba(26,29,36,0.07);
      --shadow-lg: 0 8px 24px rgba(26,29,36,0.09);
      
      --radius: 10px;
      --radius-lg: 14px;
      
      --font-serif: 'Cormorant Garamond', 'Noto Serif SC', Georgia, serif;
      --font-body: 'Noto Serif SC', -apple-system, sans-serif;
      
      --ease: cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    
    body {
      font-family: var(--font-body);
      background: var(--frost);
      color: var(--ink);
      font-size: 14px;
      line-height: 1.65;
      font-weight: 400;
    }

    .app {
      max-width: 414px;
      margin: 0 auto;
      min-height: 100vh;
      background: var(--snow);
      position: relative;
    }

    .page { display: none; min-height: 100vh; }
    .page.active { display: block; animation: fadeIn 0.3s var(--ease); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* =============== ÁôªÂΩïÈ°µ =============== */
    .login-page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 40px 32px;
      background: linear-gradient(165deg, #F8FAFB 0%, #EEF2F5 50%, #E8EDF2 100%);
      position: relative;
      overflow: hidden;
    }

    .login-page::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -30%;
      width: 80%;
      height: 100%;
      background: radial-gradient(ellipse, rgba(74,124,155,0.06) 0%, transparent 70%);
      pointer-events: none;
    }

    .login-page::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -20%;
      width: 60%;
      height: 80%;
      background: radial-gradient(ellipse, rgba(232,90,90,0.04) 0%, transparent 70%);
      pointer-events: none;
    }

    .brand {
      text-align: center;
      margin-bottom: 56px;
      position: relative;
      z-index: 1;
    }

    .brand-label {
      display: block;
      font-size: 9px;
      letter-spacing: 0.35em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 32px;
    }

    .brand-icon {
      width: 52px;
      height: 52px;
      margin: 0 auto 24px;
      position: relative;
      animation: heartbeat 2s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .brand-icon svg {
      width: 100%;
      height: 100%;
      fill: #E85A5A;
      stroke: none;
      filter: drop-shadow(0 4px 12px rgba(232,90,90,0.3));
    }

    .brand-title {
      font-family: var(--font-serif);
      font-size: 46px;
      font-weight: 400;
      font-style: italic;
      letter-spacing: 0.02em;
      margin-bottom: 14px;
      color: var(--deep);
      line-height: 1.1;
    }

    .brand-sub {
      font-size: 13px;
      color: var(--steel);
      letter-spacing: 0.15em;
      margin-bottom: 8px;
    }

    .brand-quote {
      font-family: var(--font-serif);
      font-size: 12px;
      font-style: italic;
      color: var(--muted);
      letter-spacing: 0.05em;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--frost);
      max-width: 240px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.7;
    }

    .login-box {
      max-width: 300px;
      margin: 0 auto;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .login-step { display: none; }
    .login-step.active { display: block; }

    .step-title {
      text-align: center;
      font-size: 11px;
      color: var(--slate);
      margin-bottom: 24px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .identity-options {
      display: flex;
      gap: 20px;
      margin-bottom: 24px;
    }

    .identity-btn {
      flex: 1;
      padding: 32px 16px 28px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.8);
      border-radius: var(--radius-lg);
      cursor: pointer;
      transition: all 0.3s var(--ease);
      text-align: center;
      box-shadow: 0 2px 12px rgba(26,29,36,0.04);
      position: relative;
      overflow: hidden;
    }

    .identity-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .identity-btn:hover {
      background: rgba(255,255,255,0.9);
      border-color: var(--silver);
      box-shadow: 0 8px 24px rgba(26,29,36,0.08);
      transform: translateY(-3px);
    }

    .identity-btn:hover::before {
      opacity: 1;
    }

    .identity-btn.selected {
      background: rgba(255,255,255,0.95);
      border-color: var(--accent);
      box-shadow: 0 8px 24px rgba(74,124,155,0.15);
    }

    .identity-btn.selected::before {
      opacity: 1;
    }

    .identity-btn .avatar-wrap {
      width: 80px;
      height: 80px;
      margin: 0 auto 18px;
      position: relative;
    }

    .identity-btn .avatar-frame {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      padding: 3px;
      background: linear-gradient(135deg, rgba(232,180,184,0.3) 0%, rgba(165,196,212,0.3) 100%);
    }

    .identity-btn[data-role="cat"] .avatar-frame {
      background: linear-gradient(135deg, #E8B4B8 0%, #D4A5A5 100%);
    }

    .identity-btn[data-role="dog"] .avatar-frame {
      background: linear-gradient(135deg, #A5C4D4 0%, #8FB8C8 100%);
    }

    .identity-btn .avatar-inner {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: var(--snow);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .identity-btn .avatar-letter {
      font-family: var(--font-serif);
      font-size: 32px;
      font-style: italic;
      font-weight: 400;
      background: linear-gradient(135deg, #E8B4B8 0%, #D4A5A5 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .identity-btn[data-role="dog"] .avatar-letter {
      background: linear-gradient(135deg, #A5C4D4 0%, #8FB8C8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .identity-btn .avatar-symbol {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 28px;
      height: 28px;
      background: var(--snow);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .identity-btn .avatar-symbol svg {
      width: 16px;
      height: 16px;
    }

    .identity-btn[data-role="cat"] .avatar-symbol svg {
      fill: #E8B4B8;
    }

    .identity-btn[data-role="dog"] .avatar-symbol svg {
      fill: #A5C4D4;
    }

    .identity-btn .name { 
      font-size: 15px; 
      color: var(--deep); 
      font-weight: 500; 
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .identity-btn .name-en {
      font-family: var(--font-serif);
      font-size: 10px;
      font-style: italic;
      color: var(--muted);
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .input-group { margin-bottom: 16px; }

    .input-label {
      display: block;
      font-size: 9px;
      color: var(--slate);
      margin-bottom: 8px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .input-field {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border: 1px solid var(--frost);
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 15px;
      color: var(--ink);
      transition: all 0.2s var(--ease);
    }

    .input-field:focus { outline: none; border-color: var(--accent); background: rgba(255,255,255,0.95); }
    .input-field.error { border-color: #B85C5C; animation: shake 0.3s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

    .input-hint { font-size: 11px; color: var(--muted); margin-top: 6px; }
    .input-error { font-size: 11px; color: #B85C5C; margin-top: 6px; display: none; }
    .input-error.show { display: block; }

    .device-hint {
      text-align: center;
      font-size: 13px;
      color: var(--steel);
      margin-bottom: 24px;
      line-height: 1.8;
    }

    .primary-btn {
      width: 100%;
      padding: 14px;
      background: var(--deep);
      border: none;
      border-radius: var(--radius);
      color: var(--snow);
      font-family: var(--font-body);
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s var(--ease);
      margin-top: 8px;
    }

    .primary-btn:hover { background: var(--ink); box-shadow: 0 4px 12px rgba(26,29,36,0.15); }
    .primary-btn:active { transform: scale(0.98); }

    .secondary-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      letter-spacing: 0.05em;
    }
    .secondary-link:hover { color: var(--steel); }

    .divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 36px 0;
      font-size: 9px;
      color: var(--silver);
      letter-spacing: 0.25em;
      text-transform: uppercase;
    }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, transparent, var(--frost), transparent); }

    .ghost-btn {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid var(--frost);
      border-radius: var(--radius);
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.1em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .ghost-btn:hover { border-color: var(--silver); color: var(--steel); background: rgba(255,255,255,0.5); }

    .login-footer {
      position: absolute;
      bottom: 32px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 10px;
      color: var(--silver);
      letter-spacing: 0.1em;
    }

    /* =============== È¶ñÈ°µ =============== */
    .home-page { 
      background: linear-gradient(180deg, var(--snow) 0%, var(--cloud) 100%);
      padding-bottom: 88px; 
      min-height: 100vh;
    }

    .home-header { 
      background: transparent;
      padding: 48px 20px 16px;
    }

    .header-row { display: flex; justify-content: space-between; align-items: center; }

    .header-title {
      font-family: var(--font-serif);
      font-size: 28px;
      font-weight: 400;
      font-style: italic;
      color: var(--deep);
    }

    .header-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      letter-spacing: 0.1em;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border-radius: 100px;
      font-size: 11px;
      color: var(--steel);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    /* Áä∂ÊÄÅÂç°Áâá */
    .status-section { 
      background: transparent;
      padding: 16px 20px 24px; 
    }
    .status-row { display: flex; gap: 14px; }

    .status-card {
      flex: 1;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 24px 18px;
      border: 1px solid rgba(255,255,255,0.9);
      box-shadow: 0 4px 20px rgba(26,29,36,0.05);
      position: relative;
      overflow: hidden;
    }

    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, rgba(232,90,90,0.06) 0%, transparent 70%);
      pointer-events: none;
    }

    .status-num {
      font-family: var(--font-serif);
      font-size: 42px;
      font-weight: 300;
      color: var(--deep);
      line-height: 1;
      margin-bottom: 6px;
    }

    .status-label {
      font-size: 9px;
      color: var(--slate);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .status-sub { 
      font-size: 11px; 
      color: var(--muted); 
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ÂàÜÂå∫ */
    .section-block { 
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(8px);
      margin: 12px 16px;
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 12px rgba(26,29,36,0.04);
    }
    .section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }

    .section-title {
      font-size: 10px;
      font-weight: 500;
      color: var(--slate);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .section-action { font-size: 11px; color: var(--muted); cursor: pointer; }
    .section-action:hover { color: var(--accent); }

    /* Âä®ÊÄÅÂàóË°® */
    .update-item {
      display: flex;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid var(--frost);
      cursor: pointer;
    }
    .update-item:last-child { border-bottom: none; }

    .update-indicator { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; margin-top: 7px; flex-shrink: 0; }
    .update-indicator.read { background: var(--frost); }
    .update-body { flex: 1; }
    .update-text { font-size: 13px; color: var(--deep); line-height: 1.6; }
    .update-text b { font-weight: 500; color: var(--ink); }
    .update-time { font-size: 10px; color: var(--muted); margin-top: 4px; }

    .empty-block { text-align: center; padding: 32px 16px; color: var(--muted); font-size: 12px; }

    /* ÂõûÂøÜÂç°Áâá */
    .memory-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,251,0.9) 100%);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s var(--ease);
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 4px 16px rgba(26,29,36,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .memory-card::after {
      content: '‚ú®';
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 16px;
      opacity: 0.6;
    }
    
    .memory-card:hover { 
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(26,29,36,0.08);
    }

    .memory-tag {
      display: inline-block;
      padding: 4px 12px;
      background: linear-gradient(135deg, var(--accent-soft) 0%, rgba(74,124,155,0.08) 100%);
      border-radius: 100px;
      font-size: 9px;
      color: var(--accent);
      margin-bottom: 12px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 500;
    }

    .memory-title { font-family: var(--font-serif); font-size: 19px; font-style: italic; color: var(--ink); margin-bottom: 8px; }
    .memory-excerpt { font-size: 12px; color: var(--steel); line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .memory-footer { font-size: 11px; color: var(--muted); margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--frost); }

    /* Êó•ËÆ∞ÂàóË°® */
    .diary-section { 
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      margin: 12px 16px;
      padding: 20px;
      border-radius: var(--radius-lg);
      box-shadow: 0 2px 12px rgba(26,29,36,0.04);
    }
    .search-box { margin-bottom: 14px; }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(242,244,247,0.8);
      border: 1px solid transparent;
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 12px;
      color: var(--ink);
      transition: all 0.2s;
    }
    .search-input::placeholder { color: var(--muted); }
    .search-input:focus { outline: none; border-color: var(--accent); background: var(--snow); }

    .date-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 14px;
    }
    
    .date-input {
      flex: 1;
      padding: 10px 12px;
      background: var(--cloud);
      border: none;
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 12px;
      color: var(--ink);
    }
    .date-input:focus { outline: none; box-shadow: inset 0 0 0 1px var(--accent); }
    
    .date-sep { color: var(--muted); font-size: 12px; }
    
    .date-clear {
      padding: 10px 12px;
      background: transparent;
      border: 1px solid var(--frost);
      border-radius: var(--radius);
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      white-space: nowrap;
    }
    .date-clear:hover { border-color: var(--silver); color: var(--steel); }

    .filter-tabs { display: flex; gap: 8px; margin-bottom: 18px; }

    .filter-tab {
      padding: 7px 14px;
      background: var(--cloud);
      border: none;
      border-radius: 100px;
      font-family: var(--font-body);
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-tab:hover { color: var(--steel); }
    .filter-tab.active { background: var(--deep); color: var(--snow); }

    .diary-item {
      background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,251,0.8) 100%);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.25s var(--ease);
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 2px 8px rgba(26,29,36,0.03);
    }
    .diary-item:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26,29,36,0.07);
    }

    .diary-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .diary-date { font-size: 10px; color: var(--muted); letter-spacing: 0.08em; }
    .diary-mood { font-size: 16px; }
    .diary-title { font-family: var(--font-serif); font-size: 18px; font-style: italic; color: var(--ink); margin-bottom: 6px; }
    .diary-by { font-size: 10px; color: var(--muted); margin-bottom: 10px; }
    .diary-excerpt { font-size: 12px; color: var(--steel); line-height: 1.7; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .diary-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--frost); }
    .diary-tags { font-size: 10px; color: var(--accent); }
    .diary-comments { font-size: 10px; color: var(--muted); }

    /* =============== ÂÜôÊó•ËÆ∞È°µ =============== */
    .write-page { 
      background: linear-gradient(180deg, var(--snow) 0%, var(--cloud) 100%);
      min-height: 100vh; 
    }

    .write-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--frost);
      position: relative;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
    }

    .write-back { position: absolute; left: 16px; background: none; border: none; font-size: 12px; color: var(--muted); cursor: pointer; letter-spacing: 0.05em; }
    .write-nav-title { font-family: var(--font-serif); font-size: 18px; font-style: italic; color: var(--deep); }

    .write-body { padding: 28px 20px 40px; }
    .write-group { margin-bottom: 28px; }

    .write-label {
      font-size: 9px;
      color: var(--slate);
      margin-bottom: 12px;
      display: block;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      font-weight: 500;
    }

    .write-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--frost);
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--ink);
      transition: all 0.2s;
    }
    .write-input:focus { outline: none; border-color: var(--accent); background: var(--snow); }
    .write-textarea { min-height: 200px; resize: none; line-height: 2; }
    .char-counter { text-align: right; font-size: 10px; color: var(--muted); margin-top: 8px; }
    .char-counter.warn { color: #B85C5C; }
    .char-counter.ok { color: var(--accent); }

    .option-group { display: flex; gap: 8px; flex-wrap: wrap; }

    .option-btn {
      padding: 10px 14px;
      background: var(--cloud);
      border: 1px solid transparent;
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 12px;
      color: var(--steel);
      cursor: pointer;
      transition: all 0.2s;
    }
    .option-btn:hover { border-color: var(--silver); }
    .option-btn.active { background: var(--deep); color: var(--snow); border-color: var(--deep); }

    .mood-btn { padding: 10px 12px; font-size: 18px; min-width: 44px; max-width: 80px; }
    .mood-btn.text-mood { font-size: 11px; }
    .tag-btn { font-size: 11px; }
    .tag-btn.active { background: var(--accent); border-color: var(--accent); }

    .custom-trigger { color: var(--muted); border: 1px dashed var(--silver); background: transparent; font-size: 14px; min-width: 44px; }
    .custom-trigger:hover { border-color: var(--accent); color: var(--steel); }
    #moodOptions .custom-trigger { font-size: 14px; padding: 10px 12px; }
    #tagOptions .custom-trigger { font-size: 10px; }

    .custom-input-wrap { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
    .custom-input { flex: 1; padding: 8px 12px; background: var(--cloud); border: 1px solid var(--frost); border-radius: var(--radius); font-family: var(--font-body); font-size: 12px; }
    .custom-input:focus { outline: none; border-color: var(--accent); }
    .custom-add { padding: 8px 12px; background: var(--deep); border: none; border-radius: var(--radius); font-size: 11px; color: var(--snow); cursor: pointer; }
    .custom-add:hover { background: var(--ink); }
    .custom-cancel { padding: 8px 12px; background: transparent; border: 1px solid var(--frost); border-radius: var(--radius); font-size: 11px; color: var(--muted); cursor: pointer; }

    .save-btn {
      width: 100%;
      padding: 16px;
      background: var(--deep);
      border: none;
      border-radius: var(--radius);
      color: var(--snow);
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }
    .save-btn:hover { background: var(--ink); }
    .save-btn:active { transform: scale(0.98); }

    /* =============== ËØ¶ÊÉÖÈ°µ =============== */
    .detail-page { 
      background: linear-gradient(180deg, var(--snow) 0%, var(--cloud) 100%);
      min-height: 100vh; 
      padding-bottom: 20px; 
    }

    .detail-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      position: sticky;
      top: 0;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      z-index: 10;
      border-bottom: 1px solid var(--frost);
    }

    .nav-btn {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(242,244,247,0.8);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
    }
    .nav-btn:hover { background: var(--frost); }
    .nav-btn svg { width: 18px; height: 18px; stroke: var(--steel); stroke-width: 1.5; fill: none; }
    .nav-actions { display: flex; gap: 8px; }

    .detail-body { padding: 28px 20px; }
    .detail-meta { display: flex; align-items: center; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
    .detail-date { font-size: 11px; color: var(--muted); letter-spacing: 0.08em; }
    .detail-author { font-size: 10px; padding: 5px 12px; background: linear-gradient(135deg, var(--cloud) 0%, var(--frost) 100%); border-radius: 100px; color: var(--steel); }
    .detail-mood { font-size: 16px; }
    .detail-title { font-family: var(--font-serif); font-size: 28px; font-weight: 400; font-style: italic; line-height: 1.4; margin-bottom: 28px; color: var(--deep); }
    .detail-content { font-size: 15px; line-height: 2.1; color: var(--deep); margin-bottom: 32px; }
    .detail-content p { margin-bottom: 1.2em; }
    .detail-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 36px; }
    .detail-tag { padding: 6px 14px; background: var(--accent-soft); border-radius: 100px; font-size: 10px; color: var(--accent); font-weight: 500; }

    .interact-section { 
      background: linear-gradient(180deg, var(--cloud) 0%, var(--frost) 100%);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
      padding: 24px 20px 32px; 
      margin: 0 -20px; 
    }
    .interact-title { font-size: 10px; font-weight: 500; color: var(--slate); margin-bottom: 16px; letter-spacing: 0.15em; text-transform: uppercase; }

    .comment-list { margin-bottom: 20px; max-height: 320px; overflow-y: auto; }
    .comment-item { margin-bottom: 12px; }
    .comment-bubble { max-width: 80%; padding: 12px 16px; background: rgba(255,255,255,0.9); border-radius: var(--radius); box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .comment-item.cat .comment-bubble { margin-right: auto; border-bottom-left-radius: 4px; }
    .comment-item.dog .comment-bubble { margin-left: auto; border-bottom-right-radius: 4px; }
    .comment-from { font-size: 10px; color: var(--muted); margin-bottom: 4px; }
    .comment-text { font-size: 13px; color: var(--deep); line-height: 1.6; }
    .comment-time { font-size: 10px; color: var(--muted); margin-top: 4px; text-align: right; }
    .comment-item.action { text-align: center; }
    .comment-item.action .comment-bubble { display: inline-block; max-width: none; padding: 8px 18px; background: var(--accent-soft); border-radius: 100px; box-shadow: none; }
    .action-text { font-size: 12px; color: var(--accent); }

    .quick-emotions { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 18px; }
    .emotion-btn { width: 46px; height: 46px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.9); border: none; border-radius: 50%; font-size: 20px; cursor: pointer; transition: all 0.25s var(--ease); box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .emotion-btn:hover { transform: scale(1.15); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

    .comment-input-row { display: flex; gap: 10px; }
    .comment-input { flex: 1; padding: 14px 16px; background: rgba(255,255,255,0.9); border: none; border-radius: var(--radius); font-family: var(--font-body); font-size: 13px; color: var(--ink); }
    .comment-input:focus { outline: none; box-shadow: 0 0 0 2px var(--accent-soft); }
    .comment-send { padding: 14px 20px; background: var(--deep); border: none; border-radius: var(--radius); color: var(--snow); font-size: 11px; letter-spacing: 0.1em; cursor: pointer; transition: all 0.2s; }
    .comment-send:hover { background: var(--ink); }

    /* =============== Êó•ÂéÜÈ°µ =============== */
    .calendar-page { 
      background: linear-gradient(180deg, var(--snow) 0%, var(--cloud) 100%);
      padding-bottom: 88px; 
      min-height: 100vh;
    }
    .calendar-header { 
      background: transparent;
      padding: 48px 20px 16px; 
      text-align: center; 
    }
    .calendar-header h1 { 
      font-family: var(--font-serif); 
      font-size: 26px; 
      font-weight: 400; 
      font-style: italic;
      color: var(--deep);
    }

    .calendar-nav { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 16px 20px; 
      background: transparent;
    }
    .cal-nav-btn { 
      width: 36px; 
      height: 36px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(8px);
      border: none; 
      border-radius: 50%; 
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .cal-nav-btn:hover { background: var(--snow); }
    .cal-nav-btn svg { width: 16px; height: 16px; stroke: var(--steel); stroke-width: 1.5; fill: none; }
    .cal-month { font-family: var(--font-serif); font-size: 17px; font-style: italic; color: var(--deep); }

    .calendar-grid { 
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      margin: 0 16px;
      padding: 16px;
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    }
    
    .cal-legend { display: flex; justify-content: center; gap: 16px; padding: 8px 0 12px; }
    .legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--muted); }
    .legend-dot { width: 6px; height: 6px; border-radius: 50%; }
    .legend-dot.diary { background: var(--accent); }
    .legend-dot.event { background: #E8A87C; }
    
    .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 8px; }
    .cal-weekday { text-align: center; font-size: 10px; color: var(--muted); padding: 8px 0; letter-spacing: 0.05em; }
    .cal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }

    .cal-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--cloud);
      border: none;
      border-radius: var(--radius);
      font-size: 13px;
      color: var(--deep);
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    .cal-day:hover { background: var(--frost); }
    .cal-day.empty { background: transparent; cursor: default; }
    .cal-day.today { background: var(--deep); color: var(--snow); }
    .cal-day.selected { background: var(--accent); color: var(--snow); }
    .cal-day.has-diary::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--accent); border-radius: 50%; left: calc(50% - 2px); }
    .cal-day.has-event::before { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: #E8A87C; border-radius: 50%; left: calc(50% - 2px); }
    .cal-day.has-diary.has-event::after { left: calc(50% - 5px); }
    .cal-day.has-diary.has-event::before { left: calc(50% + 1px); }
    .cal-day.today.has-diary::after, .cal-day.selected.has-diary::after { background: var(--snow); }
    .cal-day.today.has-event::before, .cal-day.selected.has-event::before { background: rgba(255,255,255,0.7); }

    .calendar-content { padding: 20px 16px; }
    .cal-section { margin-bottom: 20px; }
    .cal-section-title { font-size: 10px; color: var(--slate); margin-bottom: 10px; letter-spacing: 0.1em; text-transform: uppercase; }
    .cal-card { background: var(--snow); border-radius: var(--radius); padding: 14px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
    .cal-card:hover { box-shadow: var(--shadow-sm); }
    .cal-card-title { font-size: 13px; color: var(--deep); margin-bottom: 4px; }
    .cal-card-sub { font-size: 11px; color: var(--muted); }
    .cal-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .cal-card-header .cal-card-title { flex: 1; margin-bottom: 4px; }
    .event-author { font-size: 12px; flex-shrink: 0; margin-left: 8px; }

    .add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px dashed var(--silver);
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    .add-btn:hover { border-color: var(--accent); color: var(--steel); }

    /* =============== Á∫™ÂøµÊó•È°µ =============== */
    .anniversary-page { 
      background: linear-gradient(180deg, var(--snow) 0%, var(--cloud) 100%);
      padding-bottom: 88px; 
      min-height: 100vh;
    }
    .anniv-header { 
      background: transparent;
      padding: 48px 20px 16px; 
      text-align: center; 
    }
    .anniv-header h1 { 
      font-family: var(--font-serif); 
      font-size: 26px; 
      font-weight: 400; 
      font-style: italic;
      color: var(--deep);
    }

    .anniv-content { padding: 20px 16px; }

    .together-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 40px 24px;
      text-align: center;
      margin-bottom: 24px;
      border: 1px solid rgba(255,255,255,0.8);
      box-shadow: 0 8px 32px rgba(26,29,36,0.06);
      position: relative;
      overflow: hidden;
    }
    
    .together-card::before {
      content: 'üíï';
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 20px;
      opacity: 0.5;
    }
    
    .together-card::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -20%;
      width: 60%;
      height: 60%;
      background: radial-gradient(circle, rgba(232,90,90,0.05) 0%, transparent 70%);
      pointer-events: none;
    }
    
    .together-label { font-size: 9px; color: var(--muted); margin-bottom: 10px; letter-spacing: 0.2em; text-transform: uppercase; }
    .together-num { font-family: var(--font-serif); font-size: 72px; font-weight: 300; color: var(--deep); line-height: 1; }
    .together-unit { font-size: 15px; color: var(--steel); margin-top: 6px; font-style: italic; }
    .together-date { font-size: 11px; color: var(--muted); margin-top: 14px; letter-spacing: 0.05em; }

    .anniv-item {
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      padding: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 12px rgba(26,29,36,0.04);
      transition: all 0.25s var(--ease);
    }
    
    .anniv-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26,29,36,0.07);
    }
    .anniv-icon { font-size: 28px; }
    .anniv-info { flex: 1; }
    .anniv-name { font-size: 14px; color: var(--deep); font-weight: 500; }
    .anniv-date { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .anniv-countdown { text-align: right; }
    .countdown-num { font-family: var(--font-serif); font-size: 26px; color: var(--accent); }
    .countdown-unit { font-size: 10px; color: var(--muted); }

    /* =============== ÊàëÁöÑÈ°µÈù¢ =============== */
    .mine-page { 
      background: linear-gradient(180deg, var(--snow) 0%, var(--cloud) 100%);
      padding-bottom: 88px; 
      min-height: 100vh;
    }
    .mine-header { 
      background: transparent;
      padding: 48px 20px 32px; 
      text-align: center; 
    }
    .mine-avatars { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 14px; }
    .mine-avatar { 
      width: 54px; 
      height: 54px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(8px);
      border-radius: 50%; 
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .mine-heart { font-size: 16px; color: #E85A5A; animation: heartbeat 2s ease-in-out infinite; }
    .mine-names { font-family: var(--font-serif); font-size: 20px; font-style: italic; margin-bottom: 6px; color: var(--deep); }
    .mine-days { font-size: 11px; color: var(--muted); letter-spacing: 0.05em; }
    .mine-current { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; background: rgba(255,255,255,0.8); border-radius: 100px; font-size: 10px; color: var(--steel); margin-top: 14px; }

    .mine-stats {
      display: flex;
      justify-content: center;
      gap: 36px;
      padding: 24px;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      margin: -16px 16px 0;
      border-radius: var(--radius-lg);
      box-shadow: 0 4px 20px rgba(26,29,36,0.06);
      position: relative;
    }
    .mine-stat { text-align: center; }
    .mine-stat-num { font-family: var(--font-serif); font-size: 28px; color: var(--deep); }
    .mine-stat-label { font-size: 9px; color: var(--muted); letter-spacing: 0.12em; text-transform: uppercase; }

    .mine-menu { padding: 24px 16px; }
    .menu-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 18px;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.25s var(--ease);
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    .menu-item:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
    }
    .menu-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--cloud) 0%, var(--frost) 100%); border-radius: var(--radius); font-size: 18px; }
    .menu-text { flex: 1; font-size: 13px; color: var(--deep); }
    .menu-arrow { color: var(--silver); font-size: 14px; }

    .pwd-status { padding: 14px 16px; background: var(--accent-soft); border-radius: var(--radius); margin-bottom: 12px; font-size: 12px; color: var(--steel); line-height: 1.6; display: none; }
    .pwd-status.show { display: block; }
    .pwd-status .highlight { color: var(--accent); }

    /* =============== Â∫ïÈÉ®ÂØºËà™ =============== */
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 414px;
      display: flex;
      justify-content: space-around;
      padding: 12px 16px 26px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--frost);
      z-index: 100;
    }

    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 12px;
      transition: all 0.2s;
    }
    .tab-item svg { width: 22px; height: 22px; stroke: var(--muted); stroke-width: 1.5; fill: none; transition: all 0.2s; }
    .tab-item span { font-size: 9px; color: var(--muted); transition: color 0.2s; letter-spacing: 0.05em; }
    .tab-item.active svg { stroke: var(--accent); }
    .tab-item.active span { color: var(--accent); }

    .tab-item.center { position: relative; top: -14px; }
    .tab-item.center .tab-circle { 
      width: 52px; 
      height: 52px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: linear-gradient(135deg, var(--deep) 0%, var(--ink) 100%);
      border-radius: 50%; 
      box-shadow: 0 4px 16px rgba(42,52,65,0.25);
      transition: all 0.25s var(--ease);
    }
    .tab-item.center:hover .tab-circle {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(42,52,65,0.3);
    }
    .tab-item.center svg { stroke: var(--snow); }

    /* =============== ÂºπÁ™ó =============== */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(26,29,36,0.5);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      width: 100%;
      max-width: 320px;
      background: var(--snow);
      border-radius: var(--radius-lg);
      padding: 32px 24px;
      text-align: center;
    }
    .modal-icon { font-size: 40px; margin-bottom: 16px; }
    .modal-title { font-family: var(--font-serif); font-size: 20px; font-style: italic; margin-bottom: 8px; }
    .modal-text { font-size: 13px; color: var(--steel); line-height: 1.7; margin-bottom: 24px; }
    .modal-input { width: 100%; padding: 12px 14px; background: var(--cloud); border: 1px solid var(--frost); border-radius: var(--radius); font-family: var(--font-body); font-size: 14px; color: var(--ink); text-align: center; margin-bottom: 16px; }
    .modal-input:focus { outline: none; border-color: var(--accent); }
    textarea.modal-input { text-align: left; line-height: 1.6; }
    
    .time-range {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .time-field {
      flex: 1;
    }
    
    .time-label {
      display: block;
      font-size: 10px;
      color: var(--muted);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .time-input {
      margin-bottom: 0 !important;
    }
    
    .time-sep {
      color: var(--muted);
      padding-bottom: 12px;
    }
    .modal-btn { width: 100%; padding: 12px; background: var(--deep); border: none; border-radius: var(--radius); color: var(--snow); font-size: 12px; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; }
    .modal-btn:hover { opacity: 0.9; }
    .modal-btn.danger { background: #B85C5C; }
    .modal-btn.accent { background: var(--accent); }
    .modal-cancel { margin-top: 12px; background: none; border: none; color: var(--muted); font-size: 12px; cursor: pointer; }

    /* Toast */
    .toast-wrap { position: fixed; top: 48px; left: 50%; transform: translateX(-50%); z-index: 2000; }
    .toast { padding: 10px 20px; background: var(--deep); color: var(--snow); border-radius: 100px; font-size: 12px; opacity: 0; transform: translateY(-8px); transition: all 0.25s; }
    .toast.show { opacity: 1; transform: translateY(0); }

    .float-anim { position: fixed; pointer-events: none; z-index: 1500; }
    .float-item { position: absolute; font-size: 20px; animation: floatUp 1s var(--ease) forwards; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.2); } }
  </style>
</head>
<body>
  <div class="app">
    <!-- ============ ÁôªÂΩïÈ°µ ============ -->
    <div class="page active" id="loginPage">
      <div class="login-page">
        <div class="brand">
          <div class="brand-label">Private Journal</div>
          <div class="brand-icon">
            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
          </div>
          <h1 class="brand-title">Our Diary</h1>
          <p class="brand-sub">ÂñµÂñµ & Â∞èÂùèËõã</p>
          <p class="brand-quote">"ÊØè‰∏ÄÂ§©ÔºåÈÉΩÊòØÊàë‰ª¨ÊïÖ‰∫ãÁöÑÊñ∞ÁØáÁ´†"</p>
        </div>

        <div class="login-box">
          <div class="login-step active" id="stepIdentity">
            <p class="step-title">Who are you?</p>
            <div class="identity-options">
              <button class="identity-btn" data-role="cat" onclick="selectRole('cat')">
                <div class="avatar-wrap">
                  <div class="avatar-frame">
                    <div class="avatar-inner">
                      <span class="avatar-letter">M</span>
                    </div>
                  </div>
                  <div class="avatar-symbol">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                  </div>
                </div>
                <div class="name">ÂñµÂñµ</div>
                <div class="name-en">Miaomiao</div>
              </button>
              <button class="identity-btn" data-role="dog" onclick="selectRole('dog')">
                <div class="avatar-wrap">
                  <div class="avatar-frame">
                    <div class="avatar-inner">
                      <span class="avatar-letter">X</span>
                    </div>
                  </div>
                  <div class="avatar-symbol">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                  </div>
                </div>
                <div class="name">Â∞èÂùèËõã</div>
                <div class="name-en">Xiaohuaidan</div>
              </button>
            </div>
          </div>

          <div class="login-step" id="stepPassword">
            <p class="step-title" id="pwdTitle">Set your password</p>
            <div class="input-group">
              <input type="password" class="input-field" id="pwdInput" placeholder="Enter password" maxlength="20">
              <p class="input-hint" id="pwdHint">Ëá≥Â∞ë8‰ΩçÔºåÁî®‰∫éÁôªÂΩïÂíåÈáçË¶ÅÊìç‰Ωú</p>
              <p class="input-error" id="pwdError">ÂØÜÁ†Å‰∏çÊ≠£Á°Æ</p>
            </div>
            <button class="primary-btn" id="pwdBtn" onclick="handlePassword()">Continue</button>
            <p class="secondary-link" id="forgotLink" onclick="forgotPassword()" style="display:none;">Forgot password?</p>
            <p class="secondary-link" onclick="backToIdentity()">‚Üê Back</p>
          </div>

          <div class="login-step" id="stepDeviceVerify">
            <p class="step-title">üîê Êñ∞ËÆæÂ§áÈ™åËØÅ</p>
            <p class="device-hint">Ê£ÄÊµãÂà∞Êñ∞ËÆæÂ§áÁôªÂΩï<br>ËØ∑È™åËØÅ‰Ω†ÁöÑË∫´‰ªΩ</p>
            <div class="input-group">
              <label class="input-label">Êàë‰ª¨Âú®‰∏ÄËµ∑ÁöÑÊó•Êúü</label>
              <input type="date" class="input-field" id="deviceVerifyDate">
              <p class="input-error" id="deviceError">Êó•Êúü‰∏çÊ≠£Á°ÆÔºåËØ∑ÈáçËØï</p>
            </div>
            <button class="primary-btn" onclick="verifyDevice()">Verify</button>
            <p class="secondary-link" onclick="backToPassword()">‚Üê Back</p>
          </div>

          <div class="login-step" id="stepConfirm">
            <p class="step-title">Confirm password</p>
            <div class="input-group">
              <input type="password" class="input-field" id="confirmInput" placeholder="Re-enter password" maxlength="20">
              <p class="input-error" id="confirmError">‰∏§Ê¨°ÂØÜÁ†Å‰∏ç‰∏ÄËá¥</p>
            </div>
            <button class="primary-btn" onclick="confirmPassword()">Confirm</button>
            <p class="secondary-link" onclick="backToPassword()">‚Üê Back</p>
          </div>

          <div class="divider">or</div>
          <button class="ghost-btn" onclick="showStrangerModal()">Just passing by</button>
        </div>

        <div class="login-footer">Est. 2025 October</div>
      </div>
    </div>

    <!-- ============ È¶ñÈ°µ ============ -->
    <div class="page" id="homePage">
      <div class="home-page">
        <header class="home-header">
          <div class="header-row">
            <h1 class="header-title">Diary</h1>
            <div class="header-user" onclick="showMain('minePage')">
              <span id="headerAvatar">üê±</span>
              <span id="headerName">ÂñµÂñµ</span>
            </div>
          </div>
          <p class="header-sub">ËÆ∞ÂΩïÊàë‰ª¨ÁöÑÂ∞èÊó∂ÂÖâ</p>
        </header>

        <div class="status-section">
          <div class="status-row">
            <div class="status-card">
              <div class="status-num" id="daysCount">89</div>
              <div class="status-label">Days Together</div>
              <div class="status-sub">since 2025.10.02</div>
            </div>
            <div class="status-card" id="nextAnnivCard">
              <div class="status-num">27</div>
              <div class="status-label">Days Until</div>
              <div class="status-sub">üéÇ ÂñµÂñµÁîüÊó•</div>
            </div>
          </div>
        </div>

        <div class="section-block" id="updateSection">
          <div class="section-head">
            <span class="section-title">Updates</span>
          </div>
          <div class="update-list" id="updateList"></div>
        </div>

        <div class="section-block" id="memorySection" style="display:none;">
          <div class="section-head">
            <span class="section-title">Memory</span>
            <span class="section-action" onclick="refreshMemory()">Refresh</span>
          </div>
          <div class="memory-card" id="memoryCard"></div>
        </div>

        <div class="diary-section">
          <div class="section-head">
            <span class="section-title">All Entries</span>
          </div>
          <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="Search by keyword..." oninput="searchDiaries()">
          </div>
          <div class="date-filter">
            <input type="date" class="date-input" id="dateFrom" onchange="searchDiaries()">
            <span class="date-sep">‚Äî</span>
            <input type="date" class="date-input" id="dateTo" onchange="searchDiaries()">
            <button class="date-clear" onclick="clearDateFilter()">Clear</button>
          </div>
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="cat">ÂñµÂñµ</button>
            <button class="filter-tab" data-filter="dog">Â∞èÂùèËõã</button>
          </div>
          <div class="diary-list" id="diaryList"></div>
        </div>
      </div>
    </div>

    <!-- ============ ÂÜôÊó•ËÆ∞È°µ ============ -->
    <div class="page" id="writePage">
      <div class="write-page">
        <nav class="write-nav">
          <button class="write-back" onclick="cancelWrite()">Cancel</button>
          <span class="write-nav-title">New Entry</span>
          <span></span>
        </nav>

        <div class="write-body">
          <div class="write-group">
            <label class="write-label">Date</label>
            <input type="date" class="write-input" id="writeDate">
          </div>

          <div class="write-group">
            <label class="write-label">Title</label>
            <input type="text" class="write-input" id="writeTitle" placeholder="Áªô‰ªäÂ§©Ëµ∑‰∏™ÂêçÂ≠ó">
          </div>

          <div class="write-group">
            <label class="write-label">Mood</label>
            <div class="option-group" id="moodOptions">
              <button class="option-btn mood-btn active" data-mood="‚òÄÔ∏è">‚òÄÔ∏è</button>
              <button class="option-btn mood-btn" data-mood="üå§">üå§</button>
              <button class="option-btn mood-btn" data-mood="üåß">üåß</button>
              <button class="option-btn mood-btn" data-mood="üåà">üåà</button>
              <button class="option-btn mood-btn" data-mood="üåô">üåô</button>
              <button class="option-btn mood-btn custom-trigger" onclick="showCustomMood()">+</button>
            </div>
            <div class="custom-input-wrap" id="customMoodWrap" style="display:none;">
              <input type="text" class="custom-input" id="customMood" placeholder="ËæìÂÖ•Ë°®ÊÉÖÊàñÊñáÂ≠ó">
              <button class="custom-add" onclick="addCustomMood()">Add</button>
              <button class="custom-cancel" onclick="hideCustomMood()">Cancel</button>
            </div>
          </div>

          <div class="write-group">
            <label class="write-label">Content</label>
            <textarea class="write-input write-textarea" id="writeContent" placeholder="ÂÜô‰∏ã‰ªäÂ§©ÁöÑÊïÖ‰∫ã...&#10;ÔºàËá≥Â∞ë100Â≠óÂì¶ÔΩûÔºâ" oninput="updateCharCount()"></textarea>
            <div class="char-counter" id="charCounter">0 / 100</div>
          </div>

          <div class="write-group">
            <label class="write-label">Tags</label>
            <div class="option-group" id="tagOptions">
              <button class="option-btn tag-btn" data-tag="Êó•Â∏∏">#Êó•Â∏∏</button>
              <button class="option-btn tag-btn" data-tag="Á∫¶‰ºö">#Á∫¶‰ºö</button>
              <button class="option-btn tag-btn" data-tag="ÁæéÈ£ü">#ÁæéÈ£ü</button>
              <button class="option-btn tag-btn" data-tag="ÊóÖË°å">#ÊóÖË°å</button>
              <button class="option-btn tag-btn" data-tag="Á∫™ÂøµÊó•">#Á∫™ÂøµÊó•</button>
              <button class="option-btn tag-btn" data-tag="Â∞èÁ°ÆÂπ∏">#Â∞èÁ°ÆÂπ∏</button>
              <button class="option-btn tag-btn custom-trigger" onclick="showCustomTag()">+ Custom</button>
            </div>
            <div class="custom-input-wrap" id="customTagWrap" style="display:none;">
              <input type="text" class="custom-input" id="customTag" placeholder="ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞">
              <button class="custom-add" onclick="addCustomTag()">Add</button>
              <button class="custom-cancel" onclick="hideCustomTag()">Cancel</button>
            </div>
          </div>

          <div class="write-group">
            <button class="save-btn" onclick="saveDiary()">Save Entry</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ============ ËØ¶ÊÉÖÈ°µ ============ -->
    <div class="page" id="detailPage">
      <div class="detail-page">
        <nav class="detail-nav">
          <button class="nav-btn" onclick="goBack()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <div class="nav-actions">
            <button class="nav-btn" onclick="showDeleteModal()">
              <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
            </button>
          </div>
        </nav>
        <div class="detail-body" id="detailBody"></div>
      </div>
    </div>

    <!-- ============ Êó•ÂéÜÈ°µ ============ -->
    <div class="page" id="calendarPage">
      <div class="calendar-page">
        <header class="calendar-header">
          <h1>Calendar</h1>
        </header>
        <div class="calendar-nav">
          <button class="cal-nav-btn" onclick="prevMonth()">
            <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <span class="cal-month" id="calMonth">2024Âπ¥12Êúà</span>
          <button class="cal-nav-btn" onclick="nextMonth()">
            <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>
        <div class="calendar-grid">
          <div class="cal-legend">
            <span class="legend-item"><span class="legend-dot diary"></span>Diary</span>
            <span class="legend-item"><span class="legend-dot event"></span>Event</span>
          </div>
          <div class="cal-weekdays">
            <div class="cal-weekday">Sun</div>
            <div class="cal-weekday">Mon</div>
            <div class="cal-weekday">Tue</div>
            <div class="cal-weekday">Wed</div>
            <div class="cal-weekday">Thu</div>
            <div class="cal-weekday">Fri</div>
            <div class="cal-weekday">Sat</div>
          </div>
          <div class="cal-days" id="calDays"></div>
        </div>
        <div class="calendar-content" id="calContent"></div>
      </div>
    </div>

    <!-- ============ Á∫™ÂøµÊó•È°µ ============ -->
    <div class="page" id="anniversaryPage">
      <div class="anniversary-page">
        <header class="anniv-header">
          <h1>Moments</h1>
        </header>
        <div class="anniv-content">
          <div class="together-card">
            <div class="together-label">Together For</div>
            <div class="together-num" id="togetherDays">89</div>
            <div class="together-unit">days</div>
            <div class="together-date">since 2025-10-02</div>
          </div>
          <div class="anniv-list" id="annivList"></div>
          <button class="add-btn" onclick="showAddAnnivModal()">+ Add Moment</button>
        </div>
      </div>
    </div>

    <!-- ============ ÊàëÁöÑÈ°µÈù¢ ============ -->
    <div class="page" id="minePage">
      <div class="mine-page">
        <header class="mine-header">
          <div class="mine-avatars">
            <div class="mine-avatar">üê±</div>
            <div class="mine-heart">‚ô•</div>
            <div class="mine-avatar">üê∂</div>
          </div>
          <div class="mine-names">ÂñµÂñµ & Â∞èÂùèËõã</div>
          <div class="mine-days"><span id="mineDays">89</span> days together</div>
          <div class="mine-current">Current: <span id="mineRole">üê± ÂñµÂñµ</span></div>
        </header>
        <div class="mine-stats">
          <div class="mine-stat">
            <div class="mine-stat-num" id="statDiaries">0</div>
            <div class="mine-stat-label">Entries</div>
          </div>
          <div class="mine-stat">
            <div class="mine-stat-num" id="statComments">0</div>
            <div class="mine-stat-label">Messages</div>
          </div>
          <div class="mine-stat">
            <div class="mine-stat-num" id="statAnnivs">0</div>
            <div class="mine-stat-label">Moments</div>
          </div>
        </div>
        <div class="mine-menu">
          <div class="pwd-status" id="pwdStatus"></div>
          <div class="menu-item" onclick="showChangePwdModal()">
            <div class="menu-icon">üîê</div>
            <div class="menu-text">Change Password</div>
            <div class="menu-arrow">‚Ä∫</div>
          </div>
          <div class="menu-item" onclick="showDeviceInfo()">
            <div class="menu-icon">üì±</div>
            <div class="menu-text">Trusted Devices</div>
            <div class="menu-arrow">‚Ä∫</div>
          </div>
          <div class="menu-item" onclick="exportData()">
            <div class="menu-icon">üì§</div>
            <div class="menu-text">Export Data</div>
            <div class="menu-arrow">‚Ä∫</div>
          </div>
          <div class="menu-item" onclick="showAboutModal()">
            <div class="menu-icon">üíï</div>
            <div class="menu-text">About Us</div>
            <div class="menu-arrow">‚Ä∫</div>
          </div>
          <div class="menu-item" onclick="logout()">
            <div class="menu-icon">üëã</div>
            <div class="menu-text">Sign Out</div>
            <div class="menu-arrow">‚Ä∫</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Â∫ïÈÉ®ÂØºËà™ -->
    <nav class="tab-bar" id="tabBar" style="display:none;">
      <button class="tab-item active" data-page="homePage">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span>Home</span>
      </button>
      <button class="tab-item" data-page="calendarPage">
        <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="8" cy="15" r="1" fill="currentColor"/></svg>
        <span>Calendar</span>
      </button>
      <button class="tab-item center" data-page="writePage">
        <div class="tab-circle">
          <svg viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>
        </div>
      </button>
      <button class="tab-item" data-page="anniversaryPage">
        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="none"/></svg>
        <span>Moments</span>
      </button>
      <button class="tab-item" data-page="minePage">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/></svg>
        <span>Me</span>
      </button>
    </nav>
  </div>

  <!-- ============ ÂºπÁ™ó ============ -->
  <div class="modal-overlay" id="strangerModal">
    <div class="modal">
      <div class="modal-icon">üö™</div>
      <h3 class="modal-title">Private Space</h3>
      <p class="modal-text">ËøôÊòØÂñµÂñµÂíåÂ∞èÂùèËõãÁöÑÁßòÂØÜÊó•ËÆ∞Êú¨<br><br>Â¶ÇÊûú‰Ω†‰∏çÂ∞èÂøÉÈóØËøõÊù•<br>ËØ∑ÊÇÑÊÇÑÈÄÄÂá∫Âêß ü§´<br><br>Á•ù‰Ω†‰πüÊâæÂà∞ÈÇ£‰∏™‰∫∫ üíï</p>
      <button class="modal-btn" onclick="closeModal('strangerModal')">OK</button>
    </div>
  </div>

  <div class="modal-overlay" id="resetModal">
    <div class="modal">
      <div class="modal-icon">üîê</div>
      <h3 class="modal-title">Reset Password</h3>
      <p class="modal-text">ËØ∑ËæìÂÖ•‰Ω†‰ª¨Âú®‰∏ÄËµ∑ÁöÑÊó•Êúü</p>
      <input type="date" class="modal-input" id="resetDateInput">
      <button class="modal-btn" onclick="verifyResetDate()">Verify</button>
      <button class="modal-cancel" onclick="closeModal('resetModal')">Cancel</button>
    </div>
  </div>

  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-icon" id="delIcon">üîê</div>
      <h3 class="modal-title" id="delTitle">ËØ∑ÂñµÂñµËæìÂÖ•ÂØÜÁ†Å</h3>
      <p class="modal-text" id="delText">Âà†Èô§ÈúÄË¶Å‰∏§‰∫∫Á°ÆËÆ§</p>
      <input type="password" class="modal-input" id="delPwdInput" placeholder="Enter password">
      <button class="modal-btn" onclick="confirmDel()">Confirm</button>
      <button class="modal-cancel" onclick="closeModal('deleteModal')">Cancel</button>
    </div>
  </div>

  <div class="modal-overlay" id="addAnnivModal">
    <div class="modal">
      <div class="modal-icon">üíï</div>
      <h3 class="modal-title">New Moment</h3>
      <input type="text" class="modal-input" id="annivNameInput" placeholder="Name" style="text-align:left;margin-bottom:10px;">
      <input type="date" class="modal-input" id="annivDateInput" style="margin-bottom:10px;">
      <input type="text" class="modal-input" id="annivIconInput" placeholder="Icon (e.g. üéÇ)" style="margin-bottom:16px;">
      <button class="modal-btn" onclick="addAnniversary()">Add</button>
      <button class="modal-cancel" onclick="closeModal('addAnnivModal')">Cancel</button>
    </div>
  </div>

  <div class="modal-overlay" id="addEventModal">
    <div class="modal">
      <div class="modal-icon">üìå</div>
      <h3 class="modal-title" id="eventModalTitle">New Event</h3>
      <p class="modal-text" id="eventDateText"></p>
      <input type="text" class="modal-input" id="eventTitleInput" placeholder="‰∫ãÈ°πÊ†áÈ¢ò" style="text-align:left;margin-bottom:10px;">
      <textarea class="modal-input" id="eventContentInput" placeholder="ËØ¶ÁªÜÂÜÖÂÆπÔºàÂèØÈÄâÔºâ" style="text-align:left;height:80px;resize:none;margin-bottom:10px;"></textarea>
      <div class="time-range">
        <div class="time-field">
          <label class="time-label">Start</label>
          <input type="time" class="modal-input time-input" id="eventStartTime">
        </div>
        <span class="time-sep">‚Äî</span>
        <div class="time-field">
          <label class="time-label">End</label>
          <input type="time" class="modal-input time-input" id="eventEndTime">
        </div>
      </div>
      <button class="modal-btn" id="eventSaveBtn" onclick="saveEvent()">Add</button>
      <button class="modal-cancel" onclick="closeModal('addEventModal')">Cancel</button>
    </div>
  </div>

  <div class="modal-overlay" id="viewEventModal">
    <div class="modal">
      <div class="modal-icon" id="viewEventIcon">üìå</div>
      <h3 class="modal-title" id="viewEventTitle">‰∫ãÈ°πÊ†áÈ¢ò</h3>
      <p class="modal-text" id="viewEventContent">ËØ¶ÁªÜÂÜÖÂÆπ</p>
      <p class="modal-text" id="viewEventTime" style="color:var(--accent);margin-bottom:8px;"></p>
      <p class="modal-text" id="viewEventAuthor" style="font-size:11px;color:var(--muted);margin-bottom:16px;"></p>
      <div style="display:flex;gap:10px;">
        <button class="modal-btn" id="eventEditBtn" style="flex:1;background:var(--accent);" onclick="editEvent()">Edit</button>
        <button class="modal-btn" id="eventDeleteBtn" style="flex:1;background:#B85C5C;" onclick="deleteEvent()">Delete</button>
      </div>
      <p class="modal-text" id="eventNoPermission" style="font-size:12px;color:var(--muted);margin-top:8px;display:none;">Âè™ÊúâÂàõÂª∫ËÄÖÂèØ‰ª•ÁºñËæëÊàñÂà†Èô§</p>
      <button class="modal-cancel" onclick="closeModal('viewEventModal')">Close</button>
    </div>
  </div>

  <div class="modal-overlay" id="aboutModal">
    <div class="modal">
      <div class="modal-icon">üíï</div>
      <h3 class="modal-title">Our Diary</h3>
      <p class="modal-text">ËøôÊòØÂ±û‰∫éÂñµÂñµÂíåÂ∞èÂùèËõãÁöÑÁßòÂØÜÁ©∫Èó¥<br><br>ËÆ∞ÂΩïÊØè‰∏Ä‰∏™Âπ≥Âá°ÂèàÁâπÂà´ÁöÑÊó•Â≠ê<br>ÊØè‰∏ÄÊ¨°ÂøÉÂä®ÔºåÊØè‰∏ÄÊ¨°ÊÑüÂä®<br><br>ÊÑøÊàë‰ª¨ÁöÑÁà±ÊÉÖÔºåÁªÜÊ∞¥ÈïøÊµÅ ‚ú®</p>
      <button class="modal-btn" onclick="closeModal('aboutModal')">OK</button>
    </div>
  </div>

  <div class="toast-wrap"><div class="toast" id="toast"></div></div>
  <div class="float-anim" id="floatAnim"></div>

  <script>
    const CONFIG = {
      togetherDate: '2025-10-02',
      names: { cat: 'ÂñµÂñµ', dog: 'Â∞èÂùèËõã' },
      emojis: { cat: 'üê±', dog: 'üê∂' }
    };

    let S = {
      role: null,
      diaries: [],
      anniversaries: [],
      events: [],
      currentDiaryId: null,
      currentEventId: null,
      editEventId: null,
      filter: 'all',
      calYear: new Date().getFullYear(),
      calMonth: new Date().getMonth(),
      selDate: null,
      delStep: 1,
      tempPwd: '',
      pendingLogin: false  // Á≠âÂæÖËÆæÂ§áÈ™åËØÅ
    };

    // ÁîüÊàêËÆæÂ§áÊåáÁ∫π
    function getDeviceId() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('device', 2, 2);
      const canvasData = canvas.toDataURL();
      
      const info = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset(),
        canvasData.slice(-50)
      ].join('|');
      
      // ÁÆÄÂçïhash
      let hash = 0;
      for (let i = 0; i < info.length; i++) {
        const char = info.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return 'dev_' + Math.abs(hash).toString(36);
    }

    // Ê£ÄÊü•ËÆæÂ§áÊòØÂê¶Â∑≤‰ø°‰ªª
    function isDeviceTrusted(role) {
      const deviceId = getDeviceId();
      const trusted = JSON.parse(localStorage.getItem('trustedDevices') || '{}');
      return trusted[role] && trusted[role].includes(deviceId);
    }

    // Ê∑ªÂä†‰ø°‰ªªËÆæÂ§á
    function trustDevice(role) {
      const deviceId = getDeviceId();
      const trusted = JSON.parse(localStorage.getItem('trustedDevices') || '{}');
      if (!trusted[role]) trusted[role] = [];
      if (!trusted[role].includes(deviceId)) {
        trusted[role].push(deviceId);
      }
      localStorage.setItem('trustedDevices', JSON.stringify(trusted));
    }

    function init() {
      loadData();
      const savedRole = localStorage.getItem('role');
      const pwds = getPwds();
      if (savedRole && pwds[savedRole]) {
        S.role = savedRole;
        enterApp();
      }
      initListeners();
    }

    function loadData() {
      S.diaries = JSON.parse(localStorage.getItem('diaries') || '[]');
      S.anniversaries = JSON.parse(localStorage.getItem('anniversaries') || '[]');
      S.events = JSON.parse(localStorage.getItem('events') || '[]');
      
      const dataVersion = localStorage.getItem('dataVersion');
      if (dataVersion !== 'v3') {
        S.anniversaries = [
          { id: 1, name: 'Âú®‰∏ÄËµ∑', date: CONFIG.togetherDate, icon: 'üíï' },
          { id: 2, name: 'ÂñµÂñµÁîüÊó•', date: '1981-11-07', icon: 'üéÇ' },
          { id: 3, name: 'Â∞èÂùèËõãÁîüÊó•', date: '1982-02-13', icon: 'üéÇ' }
        ];
        localStorage.setItem('dataVersion', 'v3');
        saveData();
      }
    }

    function saveData() {
      localStorage.setItem('diaries', JSON.stringify(S.diaries));
      localStorage.setItem('anniversaries', JSON.stringify(S.anniversaries));
      localStorage.setItem('events', JSON.stringify(S.events));
    }

    function getPwds() { return JSON.parse(localStorage.getItem('pwds') || '{}'); }
    function savePwd(role, pwd) { const pwds = getPwds(); pwds[role] = pwd; localStorage.setItem('pwds', JSON.stringify(pwds)); }

    function initListeners() {
      document.querySelectorAll('.tab-item').forEach(btn => {
        btn.addEventListener('click', function() {
          const page = this.dataset.page;
          if (page === 'writePage') resetWriteForm();
          showMain(page);
        });
      });

      document.querySelectorAll('.filter-tab').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-tab').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          S.filter = this.dataset.filter;
          renderDiaries();
        });
      });

      document.querySelectorAll('#moodOptions .mood-btn:not(.custom-trigger)').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('#moodOptions .mood-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
        });
      });

      document.querySelectorAll('#tagOptions .tag-btn:not(.custom-trigger)').forEach(btn => {
        btn.addEventListener('click', function() { this.classList.toggle('active'); });
      });

      document.getElementById('pwdInput').addEventListener('keyup', e => { if (e.key === 'Enter') handlePassword(); });
      document.getElementById('confirmInput').addEventListener('keyup', e => { if (e.key === 'Enter') confirmPassword(); });
      document.getElementById('delPwdInput').addEventListener('keyup', e => { if (e.key === 'Enter') confirmDel(); });
      document.getElementById('deviceVerifyDate').addEventListener('keyup', e => { if (e.key === 'Enter') verifyDevice(); });
      document.getElementById('customMood').addEventListener('keyup', e => { if (e.key === 'Enter') addCustomMood(); if (e.key === 'Escape') hideCustomMood(); });
      document.getElementById('customTag').addEventListener('keyup', e => { if (e.key === 'Enter') addCustomTag(); if (e.key === 'Escape') hideCustomTag(); });
    }

    // ============ ÁôªÂΩï ============
    function selectRole(role) {
      S.role = role;
      document.querySelectorAll('.identity-btn').forEach(b => b.classList.toggle('selected', b.dataset.role === role));
      const pwds = getPwds();
      const hasP = pwds[role];
      showStep('stepPassword');
      if (hasP) {
        document.getElementById('pwdTitle').textContent = 'Enter password';
        document.getElementById('pwdHint').textContent = 'È™åËØÅË∫´‰ªΩÂêéËøõÂÖ•';
        document.getElementById('pwdBtn').textContent = 'Enter';
        document.getElementById('forgotLink').style.display = 'block';
      } else {
        document.getElementById('pwdTitle').textContent = 'Set your password';
        document.getElementById('pwdHint').textContent = 'Ëá≥Â∞ë8‰ΩçÔºåÁî®‰∫éÁôªÂΩïÂíåÈáçË¶ÅÊìç‰Ωú';
        document.getElementById('pwdBtn').textContent = 'Continue';
        document.getElementById('forgotLink').style.display = 'none';
      }
      document.getElementById('pwdInput').value = '';
      hideError('pwdError');
    }

    function showStep(id) {
      document.querySelectorAll('.login-step').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function backToIdentity() {
      showStep('stepIdentity');
      S.role = null;
      document.querySelectorAll('.identity-btn').forEach(b => b.classList.remove('selected'));
    }

    function backToPassword() { 
      showStep('stepPassword'); 
      S.pendingLogin = false;
    }

    function handlePassword() {
      const pwd = document.getElementById('pwdInput').value;
      const pwds = getPwds();
      const hasP = pwds[S.role];
      if (hasP) {
        // È™åËØÅÂØÜÁ†Å
        if (pwd === pwds[S.role]) { 
          // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ∑≤‰ø°‰ªªËÆæÂ§á
          if (isDeviceTrusted(S.role)) {
            // Â∑≤‰ø°‰ªªÔºåÁõ¥Êé•ÁôªÂΩï
            localStorage.setItem('role', S.role); 
            enterApp(); 
          } else {
            // Êñ∞ËÆæÂ§áÔºåÈúÄË¶ÅÈ¢ùÂ§ñÈ™åËØÅ
            S.pendingLogin = true;
            showStep('stepDeviceVerify');
            document.getElementById('deviceVerifyDate').value = '';
            hideError('deviceError');
          }
        }
        else { 
          showError('pwdError', 'ÂØÜÁ†Å‰∏çÊ≠£Á°Æ'); 
          document.getElementById('pwdInput').classList.add('error'); 
          setTimeout(() => document.getElementById('pwdInput').classList.remove('error'), 300); 
        }
      } else {
        // ËÆæÁΩÆÊñ∞ÂØÜÁ†Å
        if (pwd.length < 8) { showError('pwdError', 'ÂØÜÁ†ÅËá≥Â∞ëÈúÄË¶Å8‰Ωç'); return; }
        S.tempPwd = pwd;
        showStep('stepConfirm');
        document.getElementById('confirmInput').value = '';
        hideError('confirmError');
      }
    }

    function verifyDevice() {
      const date = document.getElementById('deviceVerifyDate').value;
      if (date === CONFIG.togetherDate) {
        // È™åËØÅÊàêÂäüÔºåÊ∑ªÂä†‰ø°‰ªªËÆæÂ§á
        trustDevice(S.role);
        localStorage.setItem('role', S.role);
        toast('ËÆæÂ§áÂ∑≤‰ø°‰ªª ‚úì');
        enterApp();
      } else {
        showError('deviceError', 'Êó•Êúü‰∏çÊ≠£Á°ÆÔºåËØ∑ÈáçËØï');
        document.getElementById('deviceVerifyDate').classList.add('error');
        setTimeout(() => document.getElementById('deviceVerifyDate').classList.remove('error'), 300);
      }
    }

    function confirmPassword() {
      const pwd = document.getElementById('confirmInput').value;
      if (pwd === S.tempPwd) { 
        savePwd(S.role, pwd); 
        trustDevice(S.role);  // È¶ñÊ¨°ËÆæÁΩÆÂØÜÁ†ÅÔºåËá™Âä®‰ø°‰ªªÂΩìÂâçËÆæÂ§á
        localStorage.setItem('role', S.role); 
        enterApp(); 
        toast('Welcome! ‚ú®'); 
      }
      else { 
        showError('confirmError', '‰∏§Ê¨°ÂØÜÁ†Å‰∏ç‰∏ÄËá¥'); 
        document.getElementById('confirmInput').classList.add('error'); 
        setTimeout(() => document.getElementById('confirmInput').classList.remove('error'), 300); 
      }
    }

    function forgotPassword() {
      document.getElementById('resetDateInput').value = '';
      openModal('resetModal');
    }

    function verifyResetDate() {
      const d = document.getElementById('resetDateInput').value;
      if (d === CONFIG.togetherDate) {
        closeModal('resetModal');
        S.tempPwd = '';
        document.getElementById('pwdTitle').textContent = 'Set new password';
        document.getElementById('pwdHint').textContent = 'Ëá≥Â∞ë8‰Ωç';
        document.getElementById('pwdBtn').textContent = 'Continue';
        document.getElementById('forgotLink').style.display = 'none';
        document.getElementById('pwdInput').value = '';
        const pwds = getPwds(); delete pwds[S.role]; localStorage.setItem('pwds', JSON.stringify(pwds));
        toast('È™åËØÅÊàêÂäüÔºåËØ∑ËÆæÁΩÆÊñ∞ÂØÜÁ†Å');
      } else { toast('Êó•Êúü‰∏çÂØπÂì¶'); }
    }

    function enterApp() {
      showPage('homePage');
      document.getElementById('tabBar').style.display = 'flex';
      updateHeader();
      updateDays();
      renderUpdates();
      renderMemory();
      renderNextAnniv();
      renderDiaries();
      renderCalendar();
      renderAnnivs();
      updateStats();
    }

    function logout() {
      localStorage.removeItem('role');
      S.role = null;
      document.getElementById('tabBar').style.display = 'none';
      showPage('loginPage');
      showStep('stepIdentity');
      document.querySelectorAll('.identity-btn').forEach(b => b.classList.remove('selected'));
    }

    // ============ È°µÈù¢ ============
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showMain(id) {
      showPage(id);
      document.querySelectorAll('.tab-item').forEach(t => t.classList.toggle('active', t.dataset.page === id));
      if (id === 'homePage') { renderUpdates(); renderMemory(); renderNextAnniv(); renderDiaries(); }
      else if (id === 'calendarPage') { renderCalendar(); renderCalContent(); }
      else if (id === 'anniversaryPage') { renderAnnivs(); }
      else if (id === 'minePage') { updateMine(); }
    }

    function goBack() { showMain('homePage'); document.getElementById('tabBar').style.display = 'flex'; }

    // ============ È¶ñÈ°µ ============
    function updateHeader() {
      document.getElementById('headerAvatar').textContent = CONFIG.emojis[S.role];
      document.getElementById('headerName').textContent = CONFIG.names[S.role];
    }

    function updateDays() {
      const start = new Date(CONFIG.togetherDate);
      const today = new Date();
      const days = Math.floor((today - start) / 86400000);
      document.getElementById('daysCount').textContent = days;
      document.getElementById('togetherDays').textContent = days;
      document.getElementById('mineDays').textContent = days;
    }

    function renderNextAnniv() {
      const today = new Date();
      let nearest = null, minD = Infinity;
      S.anniversaries.forEach(a => {
        const ad = new Date(a.date);
        let next = new Date(today.getFullYear(), ad.getMonth(), ad.getDate());
        if (next <= today) next = new Date(today.getFullYear() + 1, ad.getMonth(), ad.getDate());
        const diff = Math.ceil((next - today) / 86400000);
        if (diff < minD && diff > 0) { minD = diff; nearest = { ...a, days: diff }; }
      });
      const card = document.getElementById('nextAnnivCard');
      if (nearest) {
        card.innerHTML = `<div class="status-num">${nearest.days}</div><div class="status-label">Days Until</div><div class="status-sub">${nearest.icon} ${nearest.name}</div>`;
      }
    }

    function renderUpdates() {
      const other = S.role === 'cat' ? 'dog' : 'cat';
      const list = document.getElementById('updateList');
      const updates = [];
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // 1. Á∫™ÂøµÊó•ÊèêÈÜíÔºà3Â§©ÂÜÖÔºâ
      S.anniversaries.forEach(a => {
        const ad = new Date(a.date);
        let next = new Date(today.getFullYear(), ad.getMonth(), ad.getDate());
        if (next < today) next = new Date(today.getFullYear() + 1, ad.getMonth(), ad.getDate());
        const days = Math.ceil((next - today) / 86400000);
        if (days === 0) {
          updates.push({ type: 'anniv', icon: a.icon, text: `‰ªäÂ§©ÊòØ <b>${a.name}</b>ÔºÅ`, time: 'Today', priority: 1 });
        } else if (days === 1) {
          updates.push({ type: 'anniv', icon: a.icon, text: `<b>${a.name}</b> Â∞±ÊòØÊòéÂ§©`, time: 'Tomorrow', priority: 2 });
        } else if (days <= 3) {
          updates.push({ type: 'anniv', icon: a.icon, text: `<b>${a.name}</b> ËøòÊúâ${days}Â§©`, time: `${days}d`, priority: 3 });
        }
      });

      // 2. ÈáåÁ®ãÁ¢ëÊèêÈÜí
      const togetherStart = new Date(CONFIG.togetherDate);
      const togetherDays = Math.floor((today - togetherStart) / 86400000);
      const milestones = [100, 200, 300, 365, 500, 520, 730, 1000, 1314];
      milestones.forEach(m => {
        if (togetherDays === m) {
          updates.push({ type: 'milestone', icon: '‚ú®', text: `‰ªäÂ§©ÊòØÂú®‰∏ÄËµ∑ <b>Á¨¨${m}Â§©</b>`, time: 'Today', priority: 1 });
        } else if (togetherDays === m - 1) {
          updates.push({ type: 'milestone', icon: '‚ú®', text: `ÊòéÂ§©ÊòØÂú®‰∏ÄËµ∑ <b>${m}Â§©</b>`, time: 'Tomorrow', priority: 2 });
        }
      });

      // 3. Êó•ËÆ∞ÁØáÊï∞ÈáåÁ®ãÁ¢ë
      const diaryCount = S.diaries.length;
      const diaryMilestones = [10, 20, 50, 100, 200];
      if (diaryMilestones.includes(diaryCount)) {
        updates.push({ type: 'milestone', icon: 'üìù', text: `‰Ω†‰ª¨ÂÜô‰∫Ü <b>Á¨¨${diaryCount}ÁØá</b> Êó•ËÆ∞ÔºÅ`, time: 'Now', priority: 2 });
      }

      // 4. Êó•ÂéÜ‰∫ãÈ°πÊèêÈÜíÔºà‰ªäÊòé‰∏§Â§©Ôºâ
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      const todayStr = today.toISOString().split('T')[0];
      const tomorrowStr = tomorrow.toISOString().split('T')[0];
      
      S.events.forEach(e => {
        const timeDisplay = e.startTime || e.time || '';
        if (e.date === todayStr) {
          updates.push({ type: 'event', icon: 'üìå', text: `‰ªäÂ§©${timeDisplay ? ' ' + timeDisplay : ''}Ôºö<b>${e.title}</b>`, time: timeDisplay || 'Today', priority: 1, id: e.id });
        } else if (e.date === tomorrowStr) {
          updates.push({ type: 'event', icon: 'üìå', text: `ÊòéÂ§©${timeDisplay ? ' ' + timeDisplay : ''}Ôºö<b>${e.title}</b>`, time: timeDisplay || 'Tomorrow', priority: 2, id: e.id });
        }
      });

      // 5. ÂØπÊñπÁöÑÊó•ËÆ∞
      S.diaries.filter(d => d.author === other).slice(-3).reverse().forEach(d => {
        updates.push({ type: 'diary', icon: CONFIG.emojis[other], text: `${CONFIG.names[other]} wrote "<b>${d.title}</b>"`, time: formatTime(d.createdAt), priority: 4, id: d.id });
      });

      // 6. ÂØπÊñπÁöÑ‰∫íÂä®
      S.diaries.forEach(d => {
        if (d.author === S.role && d.comments) {
          d.comments.filter(c => c.author === other).slice(-2).forEach(c => {
            updates.push({ type: 'comment', icon: CONFIG.emojis[other], text: c.type === 'action' ? `${CONFIG.names[other]} ${c.content}` : `${CONFIG.names[other]} replied`, time: c.time || 'Now', priority: 4, id: d.id });
          });
        }
      });

      // Êåâ‰ºòÂÖàÁ∫ßÊéíÂ∫è
      updates.sort((a, b) => a.priority - b.priority);

      if (updates.length === 0) {
        list.innerHTML = '<div class="empty-block">No updates yet</div>';
      } else {
        list.innerHTML = updates.slice(0, 6).map(u => {
          const clickAction = u.id ? (u.type === 'event' ? `onclick="showEventDetail('${u.id}')"` : `onclick="showDetail('${u.id}')"`) : '';
          return `<div class="update-item" ${clickAction}>
            <div class="update-indicator ${u.priority > 3 ? 'read' : ''}"></div>
            <div class="update-body">
              <div class="update-text">${u.icon} ${u.text}</div>
              <div class="update-time">${u.time}</div>
            </div>
          </div>`;
        }).join('');
      }
    }

    function renderMemory() {
      const section = document.getElementById('memorySection');
      const card = document.getElementById('memoryCard');
      if (S.diaries.length < 3) { section.style.display = 'none'; return; }
      section.style.display = 'block';
      const today = new Date();
      let mem = S.diaries.find(d => { const dd = new Date(d.date); return dd.getMonth() === today.getMonth() && dd.getDate() === today.getDate() && dd.getFullYear() < today.getFullYear(); });
      if (!mem) { const old = S.diaries.filter(d => (Date.now() - new Date(d.date)) > 7 * 86400000); if (old.length) mem = old[Math.floor(Math.random() * old.length)]; }
      if (!mem) { section.style.display = 'none'; return; }
      const dd = new Date(mem.date);
      const isToday = dd.getMonth() === today.getMonth() && dd.getDate() === today.getDate();
      const tag = isToday ? `${today.getFullYear() - dd.getFullYear()} years ago` : 'Random memory';
      card.innerHTML = `<div class="memory-tag">${tag}</div><div class="memory-title">${mem.title}</div><div class="memory-excerpt">${mem.content}</div><div class="memory-footer">${CONFIG.emojis[mem.author]} ${CONFIG.names[mem.author]} ¬∑ ${mem.mood}</div>`;
      card.onclick = () => showDetail(mem.id);
    }

    function refreshMemory() {
      const old = S.diaries.filter(d => (Date.now() - new Date(d.date)) > 3 * 86400000);
      if (!old.length) return;
      const mem = old[Math.floor(Math.random() * old.length)];
      const card = document.getElementById('memoryCard');
      card.innerHTML = `<div class="memory-tag">Random memory</div><div class="memory-title">${mem.title}</div><div class="memory-excerpt">${mem.content}</div><div class="memory-footer">${CONFIG.emojis[mem.author]} ${CONFIG.names[mem.author]} ¬∑ ${mem.mood}</div>`;
      card.onclick = () => showDetail(mem.id);
      toast('Refreshed');
    }

    function renderDiaries() {
      let list = [...S.diaries].sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // ‰ΩúËÄÖÁ≠õÈÄâ
      if (S.filter !== 'all') list = list.filter(d => d.author === S.filter);
      
      // ÂÖ≥ÈîÆËØçÊêúÁ¥¢
      const search = document.getElementById('searchInput').value.toLowerCase();
      if (search) list = list.filter(d => d.title.toLowerCase().includes(search) || d.content.toLowerCase().includes(search) || (d.tags && d.tags.some(t => t.toLowerCase().includes(search))));
      
      // Êó•ÊúüËåÉÂõ¥Á≠õÈÄâ
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      if (dateFrom) list = list.filter(d => d.date >= dateFrom);
      if (dateTo) list = list.filter(d => d.date <= dateTo);
      
      const el = document.getElementById('diaryList');
      if (!list.length) { el.innerHTML = '<div class="empty-block">No entries found</div>'; return; }
      el.innerHTML = list.map(d => {
        const dd = new Date(d.date);
        const dateStr = `${dd.getFullYear()}.${dd.getMonth() + 1}.${dd.getDate()}`;
        return `<div class="diary-item" onclick="showDetail('${d.id}')"><div class="diary-top"><span class="diary-date">${dateStr}</span><span class="diary-mood">${d.mood}</span></div><div class="diary-title">${d.title}</div><div class="diary-by">${CONFIG.emojis[d.author]} ${CONFIG.names[d.author]}</div><div class="diary-excerpt">${d.content}</div><div class="diary-bottom"><span class="diary-tags">${d.tags.map(t => '#' + t).join(' ')}</span><span class="diary-comments">üí¨ ${(d.comments || []).length}</span></div></div>`;
      }).join('');
    }

    function searchDiaries() { renderDiaries(); }
    
    function clearDateFilter() {
      document.getElementById('dateFrom').value = '';
      document.getElementById('dateTo').value = '';
      renderDiaries();
    }

    // ============ ÂÜôÊó•ËÆ∞ ============
    function resetWriteForm() {
      document.getElementById('writeDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('writeTitle').value = '';
      document.getElementById('writeContent').value = '';
      document.querySelectorAll('#moodOptions .mood-btn').forEach((b, i) => b.classList.toggle('active', i === 0));
      document.querySelectorAll('#tagOptions .tag-btn').forEach(b => b.classList.remove('active'));
      hideCustomMood(); hideCustomTag();
      updateCharCount();
    }

    function updateCharCount() {
      const len = document.getElementById('writeContent').value.length;
      const el = document.getElementById('charCounter');
      el.textContent = `${len} / 100`;
      el.className = 'char-counter ' + (len >= 100 ? 'ok' : 'warn');
    }

    function showCustomMood() { document.getElementById('customMoodWrap').style.display = 'flex'; document.getElementById('customMood').focus(); }
    function hideCustomMood() { document.getElementById('customMoodWrap').style.display = 'none'; document.getElementById('customMood').value = ''; }
    function showCustomTag() { document.getElementById('customTagWrap').style.display = 'flex'; document.getElementById('customTag').focus(); }
    function hideCustomTag() { document.getElementById('customTagWrap').style.display = 'none'; document.getElementById('customTag').value = ''; }

    function addCustomMood() {
      const val = document.getElementById('customMood').value.trim();
      if (!val) return;
      const btn = document.createElement('button');
      btn.className = 'option-btn mood-btn' + (val.length > 2 ? ' text-mood' : '');
      btn.dataset.mood = val;
      btn.textContent = val;
      btn.addEventListener('click', function() { document.querySelectorAll('#moodOptions .mood-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); });
      const trigger = document.querySelector('#moodOptions .custom-trigger');
      document.getElementById('moodOptions').insertBefore(btn, trigger);
      hideCustomMood();
      btn.click();
    }

    function addCustomTag() {
      const val = document.getElementById('customTag').value.trim();
      if (!val) return;
      const btn = document.createElement('button');
      btn.className = 'option-btn tag-btn active';
      btn.dataset.tag = val;
      btn.textContent = '#' + val;
      btn.addEventListener('click', function() { this.classList.toggle('active'); });
      const trigger = document.querySelector('#tagOptions .custom-trigger');
      document.getElementById('tagOptions').insertBefore(btn, trigger);
      hideCustomTag();
    }

    function saveDiary() {
      const date = document.getElementById('writeDate').value;
      const title = document.getElementById('writeTitle').value.trim();
      const content = document.getElementById('writeContent').value.trim();
      const mood = document.querySelector('#moodOptions .mood-btn.active')?.dataset.mood || '‚òÄÔ∏è';
      const tags = Array.from(document.querySelectorAll('#tagOptions .tag-btn.active:not(.custom-trigger)')).map(b => b.dataset.tag);
      if (!title) { toast('ËØ∑ËæìÂÖ•Ê†áÈ¢ò'); return; }
      if (content.length < 100) { const hints = [`ÊâçÂÜô‰∫Ü${content.length}Â≠óÔºåÂÜçÂ§öËØ¥‰∏§Âè•ÂòõÔΩû`, '100Â≠óÈÉΩ‰∏çÂà∞ÔºåÊòØ‰∏çÊòØÂÅ∑Êáí‰∫ÜÔºü', 'Â≠óÊï∞‰∏çÂ§üÔºå‰ªäÊôö‰∏çËÆ∏Êä±Êä±ÔºÅ']; toast(hints[Math.floor(Math.random() * hints.length)]); return; }
      S.diaries.push({ id: Date.now().toString(), date, title, content, mood, tags, author: S.role, comments: [], createdAt: new Date().toISOString() });
      saveData();
      toast('Saved ‚ú®');
      updateStats();
      showMain('homePage');
    }

    function cancelWrite() { showMain('homePage'); }

    // ============ ËØ¶ÊÉÖ ============
    function showDetail(id) {
      const d = S.diaries.find(x => x.id === id);
      if (!d) return;
      S.currentDiaryId = id;
      const dd = new Date(d.date);
      const dateStr = `${dd.getFullYear()}.${dd.getMonth() + 1}.${dd.getDate()}`;
      document.getElementById('detailBody').innerHTML = `
        <div class="detail-meta"><span class="detail-date">${dateStr}</span><span class="detail-author">${CONFIG.emojis[d.author]} ${CONFIG.names[d.author]}</span><span class="detail-mood">${d.mood}</span></div>
        <h1 class="detail-title">${d.title}</h1>
        <div class="detail-content">${d.content.split('\n').map(p => '<p>' + p + '</p>').join('')}</div>
        <div class="detail-tags">${d.tags.map(t => '<span class="detail-tag">#' + t + '</span>').join('')}</div>
        <div class="interact-section">
          <div class="interact-title">Messages</div>
          <div class="comment-list" id="commentList">${(d.comments || []).map(renderComment).join('')}</div>
          <div class="quick-emotions">
            <button class="emotion-btn" onclick="sendEmotion('üòò')">üòò</button>
            <button class="emotion-btn" onclick="sendEmotion('ü§ó')">ü§ó</button>
            <button class="emotion-btn" onclick="sendEmotion('ü•∞')">ü•∞</button>
            <button class="emotion-btn" onclick="sendEmotion('üòΩ')">üòΩ</button>
            <button class="emotion-btn" onclick="sendEmotion('ü•∫')">ü•∫</button>
          </div>
          <div class="comment-input-row">
            <input type="text" class="comment-input" id="commentInput" placeholder="Say something..." onkeyup="if(event.key==='Enter')sendComment()">
            <button class="comment-send" onclick="sendComment()">Send</button>
          </div>
        </div>
      `;
      showPage('detailPage');
      document.getElementById('tabBar').style.display = 'none';
    }

    function renderComment(c) {
      if (c.type === 'action') return `<div class="comment-item action"><div class="comment-bubble"><span class="action-text">${CONFIG.emojis[c.author]} ${c.content}</span></div></div>`;
      return `<div class="comment-item ${c.author}"><div class="comment-bubble"><div class="comment-from">${CONFIG.emojis[c.author]} ${CONFIG.names[c.author]}</div><div class="comment-text">${c.content}</div><div class="comment-time">${c.time}</div></div></div>`;
    }

    function sendComment() {
      const input = document.getElementById('commentInput');
      const text = input.value.trim();
      if (!text) return;
      const d = S.diaries.find(x => x.id === S.currentDiaryId);
      if (!d) return;
      if (!d.comments) d.comments = [];
      const now = new Date();
      d.comments.push({ type: 'text', content: text, author: S.role, time: `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}` });
      saveData();
      input.value = '';
      document.getElementById('commentList').innerHTML = d.comments.map(renderComment).join('');
      updateStats();
    }

    function sendEmotion(emoji) {
      const d = S.diaries.find(x => x.id === S.currentDiaryId);
      if (!d) return;
      if (!d.comments) d.comments = [];
      const names = { 'üòò': 'mua~', 'ü§ó': 'Êä±Êä±', 'ü•∞': 'Êë∏Â§¥', 'üòΩ': 'Ëπ≠Ëπ≠', 'ü•∫': 'ÂìºÔΩû' };
      d.comments.push({ type: 'action', content: emoji + ' ' + (names[emoji] || ''), author: S.role });
      saveData();
      document.getElementById('commentList').innerHTML = d.comments.map(renderComment).join('');
      const anim = document.getElementById('floatAnim');
      for (let i = 0; i < 4; i++) {
        setTimeout(() => {
          const el = document.createElement('div');
          el.className = 'float-item';
          el.textContent = emoji;
          el.style.left = (window.innerWidth / 2 + (Math.random() - 0.5) * 60) + 'px';
          el.style.top = (window.innerHeight / 2) + 'px';
          anim.appendChild(el);
          setTimeout(() => el.remove(), 1000);
        }, i * 80);
      }
      updateStats();
    }

    // ============ Âà†Èô§ ============
    function showDeleteModal() {
      const pwds = getPwds();
      if (!pwds.cat || !pwds.dog) {
        const missing = [];
        if (!pwds.cat) missing.push('ÂñµÂñµ');
        if (!pwds.dog) missing.push('Â∞èÂùèËõã');
        toast(`${missing.join('Âíå')}ËøòÊ≤°ËÆæÁΩÆÂØÜÁ†Å`);
        return;
      }
      S.delStep = 1;
      updateDelModal();
      openModal('deleteModal');
    }

    function updateDelModal() {
      const role = S.delStep === 1 ? 'cat' : 'dog';
      document.getElementById('delIcon').textContent = CONFIG.emojis[role];
      document.getElementById('delTitle').textContent = `ËØ∑${CONFIG.names[role]}ËæìÂÖ•ÂØÜÁ†Å`;
      document.getElementById('delText').textContent = `Âà†Èô§ÈúÄË¶Å‰∏§‰∫∫Á°ÆËÆ§ (${S.delStep}/2)`;
      document.getElementById('delPwdInput').value = '';
    }

    function confirmDel() {
      const pwd = document.getElementById('delPwdInput').value;
      const pwds = getPwds();
      const role = S.delStep === 1 ? 'cat' : 'dog';
      if (pwd === pwds[role]) {
        if (S.delStep === 1) { S.delStep = 2; updateDelModal(); toast(`${CONFIG.names[role]}Á°ÆËÆ§ ‚úì`); }
        else { S.diaries = S.diaries.filter(d => d.id !== S.currentDiaryId); saveData(); closeModal('deleteModal'); toast('Deleted'); updateStats(); goBack(); }
      } else { toast('ÂØÜÁ†Å‰∏çÂØπ'); }
    }

    // ============ Êó•ÂéÜ ============
    function renderCalendar() {
      const y = S.calYear, m = S.calMonth;
      document.getElementById('calMonth').textContent = `${y}Âπ¥${m + 1}Êúà`;
      const first = new Date(y, m, 1).getDay();
      const days = new Date(y, m + 1, 0).getDate();
      const today = new Date();
      const diaryDates = new Set(S.diaries.filter(d => { const dd = new Date(d.date); return dd.getFullYear() === y && dd.getMonth() === m; }).map(d => new Date(d.date).getDate()));
      const eventDates = new Set(S.events.filter(e => { const ed = new Date(e.date); return ed.getFullYear() === y && ed.getMonth() === m; }).map(e => new Date(e.date).getDate()));
      let html = '';
      for (let i = 0; i < first; i++) html += '<button class="cal-day empty"></button>';
      for (let d = 1; d <= days; d++) {
        const isToday = y === today.getFullYear() && m === today.getMonth() && d === today.getDate();
        const isSel = S.selDate && S.selDate.getFullYear() === y && S.selDate.getMonth() === m && S.selDate.getDate() === d;
        const hasDiary = diaryDates.has(d);
        const hasEvent = eventDates.has(d);
        let cls = 'cal-day';
        if (isToday) cls += ' today';
        if (isSel) cls += ' selected';
        if (hasDiary) cls += ' has-diary';
        if (hasEvent) cls += ' has-event';
        html += `<button class="${cls}" onclick="selectDate(${y},${m},${d})">${d}</button>`;
      }
      document.getElementById('calDays').innerHTML = html;
      renderCalContent();
    }

    function prevMonth() { S.calMonth--; if (S.calMonth < 0) { S.calMonth = 11; S.calYear--; } renderCalendar(); }
    function nextMonth() { S.calMonth++; if (S.calMonth > 11) { S.calMonth = 0; S.calYear++; } renderCalendar(); }
    function selectDate(y, m, d) { S.selDate = new Date(y, m, d); renderCalendar(); }

    function renderCalContent() {
      const date = S.selDate || new Date();
      const dateStr = date.toISOString().split('T')[0];
      const display = `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
      const diaries = S.diaries.filter(d => d.date === dateStr);
      const annivs = S.anniversaries.filter(a => { const ad = new Date(a.date); return ad.getMonth() === date.getMonth() && ad.getDate() === date.getDate(); });
      const events = S.events.filter(e => e.date === dateStr).sort((a, b) => (a.startTime || '').localeCompare(b.startTime || ''));
      let html = '';
      
      if (diaries.length) { 
        html += `<div class="cal-section"><div class="cal-section-title">Entries</div>`; 
        diaries.forEach(d => { 
          html += `<div class="cal-card" onclick="showDetail('${d.id}')"><div class="cal-card-title">${d.title}</div><div class="cal-card-sub">${d.mood} ${CONFIG.names[d.author]}</div></div>`; 
        }); 
        html += '</div>'; 
      }
      
      if (annivs.length) { 
        html += `<div class="cal-section"><div class="cal-section-title">Moments</div>`; 
        annivs.forEach(a => { 
          const ad = new Date(a.date); 
          html += `<div class="cal-card"><div class="cal-card-title">${a.icon} ${a.name}</div><div class="cal-card-sub">${ad.getMonth() + 1}Êúà${ad.getDate()}Êó•</div></div>`; 
        }); 
        html += '</div>'; 
      }
      
      html += `<div class="cal-section"><div class="cal-section-title">Events</div>`;
      if (events.length) {
        events.forEach(e => { 
          // Êó∂Èó¥ÊÆµÊòæÁ§∫
          let timeStr = '';
          if (e.startTime && e.endTime) {
            timeStr = `${e.startTime} ‚Äî ${e.endTime}`;
          } else if (e.startTime) {
            timeStr = e.startTime;
          } else if (e.time) {
            timeStr = e.time;
          }
          
          const contentStr = e.content ? `<div class="cal-card-sub">${e.content.substring(0, 30)}${e.content.length > 30 ? '...' : ''}</div>` : '';
          const authorStr = e.author ? `<span class="event-author">${CONFIG.emojis[e.author]}</span>` : '';
          html += `<div class="cal-card" onclick="showEventDetail('${e.id}')">
            <div class="cal-card-header">
              <div class="cal-card-title">${e.title}</div>
              ${authorStr}
            </div>
            ${contentStr}
            ${timeStr ? `<div class="cal-card-sub" style="color:var(--accent);">‚è∞ ${timeStr}</div>` : ''}
          </div>`; 
        });
      }
      html += `<button class="add-btn" onclick="showAddEventModal('${dateStr}','${display}')">+ Add Event</button></div>`;
      
      document.getElementById('calContent').innerHTML = html;
    }

    function showAddEventModal(dateStr, display) { 
      S.eventDate = dateStr; 
      S.editEventId = null;
      document.getElementById('eventModalTitle').textContent = 'New Event';
      document.getElementById('eventDateText').textContent = display; 
      document.getElementById('eventTitleInput').value = ''; 
      document.getElementById('eventContentInput').value = '';
      document.getElementById('eventStartTime').value = '';
      document.getElementById('eventEndTime').value = '';
      document.getElementById('eventSaveBtn').textContent = 'Add';
      openModal('addEventModal'); 
    }
    
    function saveEvent() { 
      const title = document.getElementById('eventTitleInput').value.trim(); 
      const content = document.getElementById('eventContentInput').value.trim();
      const startTime = document.getElementById('eventStartTime').value;
      const endTime = document.getElementById('eventEndTime').value;
      
      if (!title) { toast('ËØ∑ËæìÂÖ•Ê†áÈ¢ò'); return; } 
      
      if (S.editEventId) {
        // ÁºñËæëÊ®°Âºè - Ê£ÄÊü•ÊùÉÈôê
        const event = S.events.find(e => e.id === S.editEventId);
        if (event && event.author === S.role) {
          event.title = title;
          event.content = content;
          event.startTime = startTime;
          event.endTime = endTime;
          toast('Updated');
        } else {
          toast('Âè™ËÉΩ‰øÆÊîπËá™Â∑±ÂàõÂª∫ÁöÑ‰∫ãÈ°π');
          return;
        }
      } else {
        // Êñ∞Â¢ûÊ®°Âºè - ËÆ∞ÂΩïÂàõÂª∫ËÄÖ
        S.events.push({ 
          id: Date.now().toString(), 
          date: S.eventDate, 
          title,
          content,
          startTime,
          endTime,
          author: S.role,
          createdAt: new Date().toISOString()
        }); 
        toast('Added');
      }
      
      saveData(); 
      closeModal('addEventModal'); 
      renderCalContent(); 
      renderUpdates();
    }

    function showEventDetail(id) {
      const event = S.events.find(e => e.id == id);
      if (!event) return;
      
      S.currentEventId = id;
      document.getElementById('viewEventTitle').textContent = event.title;
      document.getElementById('viewEventContent').textContent = event.content || 'Êó†ËØ¶ÁªÜÂÜÖÂÆπ';
      
      // ÊòæÁ§∫Êó∂Èó¥ÊÆµ
      let timeStr = '';
      if (event.startTime && event.endTime) {
        timeStr = `‚è∞ ${event.startTime} ‚Äî ${event.endTime}`;
      } else if (event.startTime) {
        timeStr = `‚è∞ ${event.startTime}`;
      } else if (event.time) {
        // ÂÖºÂÆπÊóßÊï∞ÊçÆ
        timeStr = `‚è∞ ${event.time}`;
      }
      document.getElementById('viewEventTime').textContent = timeStr;
      
      // ÊòæÁ§∫ÂàõÂª∫ËÄÖ
      const authorName = event.author ? `${CONFIG.emojis[event.author]} ${CONFIG.names[event.author]} ÂàõÂª∫` : '';
      document.getElementById('viewEventAuthor').textContent = authorName;
      
      // Ê†πÊçÆÊùÉÈôêÊòæÁ§∫ÊåâÈíÆ
      const isOwner = event.author === S.role || !event.author; // ÂÖºÂÆπÊóßÊï∞ÊçÆ
      document.getElementById('eventEditBtn').style.display = isOwner ? 'block' : 'none';
      document.getElementById('eventDeleteBtn').style.display = isOwner ? 'block' : 'none';
      document.getElementById('eventNoPermission').style.display = isOwner ? 'none' : 'block';
      
      openModal('viewEventModal');
    }

    function editEvent() {
      const event = S.events.find(e => e.id == S.currentEventId);
      if (!event) return;
      
      // Ê£ÄÊü•ÊùÉÈôê
      if (event.author && event.author !== S.role) {
        toast('Âè™ËÉΩÁºñËæëËá™Â∑±ÂàõÂª∫ÁöÑ‰∫ãÈ°π');
        return;
      }
      
      closeModal('viewEventModal');
      
      S.editEventId = S.currentEventId;
      S.eventDate = event.date;
      
      const d = new Date(event.date);
      const display = `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó•`;
      
      document.getElementById('eventModalTitle').textContent = 'Edit Event';
      document.getElementById('eventDateText').textContent = display;
      document.getElementById('eventTitleInput').value = event.title;
      document.getElementById('eventContentInput').value = event.content || '';
      document.getElementById('eventStartTime').value = event.startTime || event.time || '';
      document.getElementById('eventEndTime').value = event.endTime || '';
      document.getElementById('eventSaveBtn').textContent = 'Save';
      
      openModal('addEventModal');
    }

    function deleteEvent() {
      const event = S.events.find(e => e.id == S.currentEventId);
      if (!event) return;
      
      // Ê£ÄÊü•ÊùÉÈôê
      if (event.author && event.author !== S.role) {
        toast('Âè™ËÉΩÂà†Èô§Ëá™Â∑±ÂàõÂª∫ÁöÑ‰∫ãÈ°π');
        return;
      }
      
      S.events = S.events.filter(e => e.id != S.currentEventId);
      saveData();
      closeModal('viewEventModal');
      renderCalContent();
      renderUpdates();
      toast('Deleted');
    }

    // ============ Á∫™ÂøµÊó• ============
    function renderAnnivs() {
      const today = new Date();
      const list = S.anniversaries.map(a => {
        const ad = new Date(a.date);
        let next = new Date(today.getFullYear(), ad.getMonth(), ad.getDate());
        if (next < today) next = new Date(today.getFullYear() + 1, ad.getMonth(), ad.getDate());
        const days = Math.ceil((next - today) / 86400000);
        const displayDate = `${ad.getMonth() + 1}Êúà${ad.getDate()}Êó•`;
        return { ...a, days, displayDate };
      }).sort((a, b) => a.days - b.days);
      document.getElementById('annivList').innerHTML = list.map(a => `<div class="anniv-item"><div class="anniv-icon">${a.icon}</div><div class="anniv-info"><div class="anniv-name">${a.name}</div><div class="anniv-date">${a.displayDate}</div></div><div class="anniv-countdown"><div class="countdown-num">${a.days}</div><div class="countdown-unit">days</div></div></div>`).join('');
      updateStats();
    }

    function showAddAnnivModal() { document.getElementById('annivNameInput').value = ''; document.getElementById('annivDateInput').value = ''; document.getElementById('annivIconInput').value = ''; openModal('addAnnivModal'); }
    function addAnniversary() { const name = document.getElementById('annivNameInput').value.trim(); const date = document.getElementById('annivDateInput').value; const icon = document.getElementById('annivIconInput').value.trim() || 'üíï'; if (!name || !date) { toast('ËØ∑Â°´ÂÜôÂÆåÊï¥'); return; } S.anniversaries.push({ id: Date.now(), name, date, icon }); saveData(); closeModal('addAnnivModal'); renderAnnivs(); renderNextAnniv(); toast('Added'); }

    // ============ ÊàëÁöÑ ============
    function updateMine() {
      document.getElementById('mineRole').textContent = CONFIG.emojis[S.role] + ' ' + CONFIG.names[S.role];
      const pwds = getPwds();
      const statusEl = document.getElementById('pwdStatus');
      if (!pwds.cat || !pwds.dog) {
        const other = S.role === 'cat' ? 'dog' : 'cat';
        if (!pwds[other]) { statusEl.innerHTML = `üí° <span class="highlight">${CONFIG.names[other]}</span>ËøòÊ≤°ËÆæÁΩÆÂØÜÁ†ÅÔºåÈúÄË¶ÅÂÖàÁôªÂΩïËÆæÁΩÆ`; statusEl.classList.add('show'); }
        else { statusEl.classList.remove('show'); }
      } else { statusEl.classList.remove('show'); }
    }

    function updateStats() {
      const comments = S.diaries.reduce((s, d) => s + (d.comments?.length || 0), 0);
      document.getElementById('statDiaries').textContent = S.diaries.length;
      document.getElementById('statComments').textContent = comments;
      document.getElementById('statAnnivs').textContent = S.anniversaries.length;
    }

    function showChangePwdModal() { toast('ÂäüËÉΩÂºÄÂèë‰∏≠'); }
    
    function showDeviceInfo() {
      const trusted = JSON.parse(localStorage.getItem('trustedDevices') || '{}');
      const currentDeviceId = getDeviceId();
      const myDevices = trusted[S.role] || [];
      
      let msg = `üì± ÂΩìÂâçËÆæÂ§á: ${currentDeviceId.slice(0,12)}...\n\n`;
      msg += `‚úÖ Â∑≤‰ø°‰ªªËÆæÂ§áÊï∞: ${myDevices.length}\n\n`;
      
      if (myDevices.length > 0) {
        msg += '‰ø°‰ªªÁöÑËÆæÂ§áID:\n';
        myDevices.forEach((d, i) => {
          const isCurrent = d === currentDeviceId;
          msg += `${i+1}. ${d.slice(0,12)}...${isCurrent ? ' (ÂΩìÂâç)' : ''}\n`;
        });
      }
      
      msg += '\nÊòØÂê¶Ê∏ÖÈô§ÊâÄÊúâ‰ø°‰ªªËÆæÂ§áÔºü\nÔºà‰∏ãÊ¨°ÁôªÂΩïÈúÄÈáçÊñ∞È™åËØÅÔºâ';
      
      if (confirm(msg)) {
        const newTrusted = {...trusted};
        delete newTrusted[S.role];
        localStorage.setItem('trustedDevices', JSON.stringify(newTrusted));
        trustDevice(S.role);
        toast('Â∑≤Ê∏ÖÈô§ÔºåÂΩìÂâçËÆæÂ§áÂ∑≤ÈáçÊñ∞‰ø°‰ªª');
      }
    }
    function showAboutModal() { openModal('aboutModal'); }

    function exportData() {
      const data = { diaries: S.diaries, anniversaries: S.anniversaries, events: S.events };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'diary_backup_' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      toast('Exported');
    }

    // ============ Â∑•ÂÖ∑ ============
    function formatTime(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      const diff = Date.now() - d;
      if (diff < 3600000) return 'Just now';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
      return `${d.getMonth() + 1}/${d.getDate()}`;
    }

    function toast(msg) { const el = document.getElementById('toast'); el.textContent = msg; el.classList.add('show'); setTimeout(() => el.classList.remove('show'), 2000); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showError(id, msg) { const el = document.getElementById(id); el.textContent = msg; el.classList.add('show'); }
    function hideError(id) { document.getElementById(id).classList.remove('show'); }
    function showStrangerModal() { openModal('strangerModal'); }

    init();
  </script>
</body>
</html>
